<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RType: RFC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">RType<span id="projectnumber">&#160;1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_doc_2RFC.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">RFC</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><div class="line">Abstract</div>
<div class="line">This document specifies the network protocol used in the RType game for communication between clients and the server. The protocol is designed to handle various aspects of the game, such as player inputs, entity updates, and connection management. The primary transport layer protocol used is ENet, which provides reliable UDP communication.</div>
<div class="line"> </div>
<div class="line">1. Introduction</div>
<div class="line">The RType network protocol facilitates communication between the client and server to ensure a seamless multiplayer experience. This protocol handles player inputs, entity state synchronization, connection management, and other essential game mechanics.</div>
<div class="line"> </div>
<div class="line">2. Protocol Overview</div>
<div class="line">The protocol operates over ENet, a reliable UDP-based networking library. Communication is achieved through the exchange of packets, each identified by a specific type. The following packet types are defined:</div>
<div class="line"> </div>
<div class="line">PACKET_PLAYER_ID</div>
<div class="line">PACKET_INITIAL_ENTITIES</div>
<div class="line">PACKET_INITIAL_ACK</div>
<div class="line">PACKET_ENTITY_UPDATE</div>
<div class="line">PACKET_INPUT</div>
<div class="line">PACKET_ENTITY_REMOVE</div>
<div class="line">3. Packet Types and Structures</div>
<div class="line">3.1. Packet Types</div>
<div class="line">PACKET_PLAYER_ID (0x01)</div>
<div class="line"> </div>
<div class="line">Sent by the server to assign a unique player ID to the client.</div>
<div class="line">Structure: [PacketType (1 byte)] [PlayerID (4 bytes)]</div>
<div class="line">PACKET_INITIAL_ENTITIES (0x02)</div>
<div class="line"> </div>
<div class="line">Sent by the server to provide initial entity states to the client.</div>
<div class="line">Structure: [PacketType (1 byte)] [EntityCount (2 bytes)] [EntityStates (variable)]</div>
<div class="line">PACKET_INITIAL_ACK (0x07)</div>
<div class="line"> </div>
<div class="line">Sent by the client to acknowledge the receipt of initial entity states.</div>
<div class="line">Structure: [PacketType (1 byte)]</div>
<div class="line">PACKET_ENTITY_UPDATE (0x03)</div>
<div class="line"> </div>
<div class="line">Sent by the server to update the states of entities.</div>
<div class="line">Structure: [PacketType (1 byte)] [EntityCount (2 bytes)] [EntityStates (variable)]</div>
<div class="line">PACKET_INPUT (0x04)</div>
<div class="line"> </div>
<div class="line">Sent by the client to convey player input commands.</div>
<div class="line">Structure: [PacketType (1 byte)] [InputFlags (2 bytes)]</div>
<div class="line">PACKET_ENTITY_REMOVE (0x05)</div>
<div class="line"> </div>
<div class="line">Sent by the server to notify the client of an entity removal.</div>
<div class="line">Structure: [PacketType (1 byte)] [EntityID (4 bytes)]</div>
<div class="line">3.2. EntityState Structure</div>
<div class="line">The EntityState structure represents the state of an entity in the game. It is used in the PACKET_INITIAL_ENTITIES and PACKET_ENTITY_UPDATE packets.</div>
<div class="line"> </div>
<div class="line">C++</div>
<div class="line">struct EntityState {</div>
<div class="line">    std::array&lt;uint8_t, 16&gt; entityId; // Unique entity identifier</div>
<div class="line">    float x, y;                       // Position coordinates</div>
<div class="line">    float vx, vy;                     // Velocity components</div>
<div class="line">    int type;                         // Entity type</div>
<div class="line">    bool isYoursServ;                 // Ownership flag</div>
<div class="line">};</div>
<div class="line">4. Client-Side Implementation</div>
<div class="line">4.1. ClientNetworkManager Class</div>
<div class="line">The ClientNetworkManager class manages the client&#39;s network operations, including connection setup, packet handling, and sending input commands.</div>
<div class="line"> </div>
<div class="line">C++</div>
<div class="line">class ClientNetworkManager {</div>
<div class="line">public:</div>
<div class="line">    ClientNetworkManager(const std::string&amp; address, uint16_t port);</div>
<div class="line">    ~ClientNetworkManager();</div>
<div class="line"> </div>
<div class="line">    void onStart();</div>
<div class="line">    void onShutdown();</div>
<div class="line">    void onUpdate(float deltaTime);</div>
<div class="line"> </div>
<div class="line">    void sendInputCommand(uint16_t inputFlags);</div>
<div class="line">    void sendInitialAck();</div>
<div class="line"> </div>
<div class="line">private:</div>
<div class="line">    void processPlayerId(const uint8_t* data, size_t size);</div>
<div class="line">    void processEntityUpdate(const uint8_t* data, size_t size);</div>
<div class="line">    void processEntityRemove(const uint8_t* data, size_t size);</div>
<div class="line"> </div>
<div class="line">    std::string address_;</div>
<div class="line">    uint16_t port_;</div>
<div class="line">    ENetHost* host_;</div>
<div class="line">    ENetPeer* peer_;</div>
<div class="line">    int player_id_;</div>
<div class="line">};</div>
<div class="line">4.2. InputComponent Structure</div>
<div class="line">The InputComponent structure stores the current inputs for an entity.</div>
<div class="line"> </div>
<div class="line">C++</div>
<div class="line">struct InputComponent {</div>
<div class="line">    std::unordered_map&lt;SDL_Keycode, InputInfo&gt; currentInputs;</div>
<div class="line">    std::queue&lt;SDL_Keycode&gt; keyLog;</div>
<div class="line">    std::size_t maxHistory = 10;</div>
<div class="line">};</div>
<div class="line">5. Server-Side Implementation</div>
<div class="line">5.1. ServerNetworkManager Class</div>
<div class="line">The ServerNetworkManager class manages the server&#39;s network operations, including connection handling, packet processing, and broadcasting entity updates.</div>
<div class="line"> </div>
<div class="line">C++</div>
<div class="line">class ServerNetworkManager : public ecs::System {</div>
<div class="line">public:</div>
<div class="line">    ServerNetworkManager();</div>
<div class="line">    ~ServerNetworkManager();</div>
<div class="line"> </div>
<div class="line">    bool initializeServer(uint16_t port);</div>
<div class="line">    void onStart() override;</div>
<div class="line">    void onUpdate(float deltaTime) override;</div>
<div class="line"> </div>
<div class="line">    void sendPlayerId(ENetPeer* peer, int entityId);</div>
<div class="line">    void broadcastEntityRemoval(int entityId);</div>
<div class="line">    void processInitialAck(ENetPeer* fromPeer);</div>
<div class="line">    void sendInitialEntities(ENetPeer* peer, const std::vector&lt;EntityState&gt;&amp; states);</div>
<div class="line">    void sendEntityUpdates(const std::vector&lt;EntityState&gt;&amp; states);</div>
<div class="line"> </div>
<div class="line">private:</div>
<div class="line">    void handleNewConnection(ENetPeer* peer);</div>
<div class="line"> </div>
<div class="line">    ENetHost* host_;</div>
<div class="line">    std::vector&lt;ENetPeer*&gt; connectedPeers_;</div>
<div class="line">    std::map&lt;ENetPeer*, bool&gt; peerInitialAck_;</div>
<div class="line">    std::map&lt;ENetPeer*, bool&gt; initialEntitiesSent_;</div>
<div class="line">};</div>
<div class="line">6. Protocol Workflow</div>
<div class="line">Connection Establishment</div>
<div class="line"> </div>
<div class="line">The client connects to the server using ENet.</div>
<div class="line">The server assigns a unique player ID and sends a PACKET_PLAYER_ID packet to the client.</div>
<div class="line">Initial Entity Synchronization</div>
<div class="line"> </div>
<div class="line">The server sends the initial state of all entities using a PACKET_INITIAL_ENTITIES packet.</div>
<div class="line">The client acknowledges receipt with a PACKET_INITIAL_ACK packet.</div>
<div class="line">Entity Updates</div>
<div class="line"> </div>
<div class="line">The server periodically sends PACKET_ENTITY_UPDATE packets to update entity states.</div>
<div class="line">The client processes these updates to synchronize the game state.</div>
<div class="line">Player Input</div>
<div class="line"> </div>
<div class="line">The client sends player input commands using PACKET_INPUT packets.</div>
<div class="line">The server processes these inputs to update the game state.</div>
<div class="line">Entity Removal</div>
<div class="line"> </div>
<div class="line">The server sends PACKET_ENTITY_REMOVE packets to notify clients of entity removals.</div>
<div class="line">The clients update their game state accordingly.</div>
<div class="line">7. Conclusion</div>
<div class="line">The RType network protocol is designed to provide efficient and reliable communication between clients and the server, ensuring smooth gameplay. By using ENet and defining specific packet types and structures, the protocol handles player inputs, entity synchronization, and connection management effectively.</div>
<div class="line"> </div>
<div class="line">For further information or clarifications, please refer to the implementation details in the provided source code or contact the author.</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
